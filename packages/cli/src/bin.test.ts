import { exec } from 'node:child_process';
import { dirname, join } from 'node:path';
import { fileURLToPath } from 'node:url';
import { promisify } from 'node:util';
import { describe, expect, it } from 'vitest';

const execAsync = promisify(exec);

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const packageRoot = dirname(__dirname);
const binPath = join(packageRoot, 'bin.mjs');

describe('CLI binary help output', () => {
  it('should display main help', async () => {
    const output = await executeBin(['--help']);
    expect(output).toMatchInlineSnapshot(`
      "Usage: qraft [options] [command]

      Generate type-safe code from OpenAPI and AsyncAPI specifications

      Options:
        -V, --version   output the version number
        -h, --help      display help for command

      Commands:
        openapi         Generate code from OpenAPI specification
        asyncapi        Generate code from AsyncAPI specification
        help [command]  display help for command

      Examples:
        # Generate React Query hooks from OpenAPI
        $ qraft openapi --plugin tanstack-query-react ./openapi.yaml -o ./src/api

        # Generate TypeScript types from OpenAPI
        $ qraft openapi --plugin openapi-typescript ./openapi.yaml -o ./src/types

        # Generate TypeScript types from AsyncAPI
        $ qraft asyncapi --plugin asyncapi-typescript ./asyncapi.yaml -o ./src/types"
    `);
  });

  describe('openapi command', () => {
    it('should display help without plugins', async () => {
      const output = await executeBin(['openapi', '--help']);
      expect(output).toMatchInlineSnapshot(`
        "ℹ ✨ OpenAPI Qraft 2.15.0-beta.0

        Usage: qraft openapi [input] [options]

        Arguments:
          input                                            Input OpenAPI Document file path, URL (json, yml) (default: null)

        Options:
          -o, --output-dir <path>                          Output directory for generated files
          -c, --clean                                      Clean output directory before generating files
          --file-header <string>                           Header to be added to the generated file (eg: /* eslint-disable */) (default: "/**\\n * This file was auto-generated by @qraft/cli.\\n * Do not make direct changes to the file.\\n */\\n\\n")
          --filter-services <glob-patterns...>             Filter services to be generated using glob patterns. Example: "/user/**,/post/**". For more details, see the NPM \`micromatch\` package documentation.
          --operation-predefined-parameters <patterns...>  Predefined parameters for services. The specified service parameters will be optional. Example: "/**:header.x-monite-version,query.x-api-key" or "get /**:header.x-monite-entity-id"
          --operation-name-modifier <patterns...>          Modifies operation names using a pattern. Use the \`==>\` operator to separate the regular expression (left) and the substitution string (right). For example: "post /**:[A-Za-z]+Id ==> createOne"
          --postfix-services <string>                      Postfix to be added to the generated service name (eg: Service)
          --service-name-base <endpoint[<index>] | tags>   Use OpenAPI Operation \`endpoint[<index>]\` path part (e.g.: "/0/1/2") or \`tags\` as the base name of the service. (default: "endpoint[0]")
          --redocly [config]                               Use the Redocly configuration to generate multiple API clients
          If the [config] parameter is not specified, the default Redocly configuration will be used: [redocly.yaml | redocly.yml | .redocly.yaml | .redocly.yml].
          For more information about this option, use the command: --redocly-help
          Examples:
          $ bin --redocly
          $ bin my-api --redocly
          $ bin my-api@v1 my-api@v2 --redocly
          $ bin --redocly ./my-redocly-config.yaml
          --plugin <name_1> --plugin <name_2>              Specifies which generator plugins should be used for code generation (choices: "tanstack-query-react", "openapi-typescript")
          -h, --help                                       display help for command"
      `);
    });

    it('should display help with tanstack-query-react plugin', async () => {
      const output = await executeBin([
        'openapi',
        '--plugin',
        'tanstack-query-react',
        '--help',
      ]);
      expect(output).toMatchInlineSnapshot(`
        "ℹ ✨ OpenAPI Qraft 2.15.0-beta.0

        Usage: qraft openapi --plugin tanstack-query-react [input] [options]

        Generate a TanStack Query React client from OpenAPI Document

        Arguments:
          input                                                         Input OpenAPI Document file path, URL (json, yml) (default: null)

        Options:
          -o, --output-dir <path>                                       Output directory for generated files
          -c, --clean                                                   Clean output directory before generating files
          --file-header <string>                                        Header to be added to the generated file (eg: /* eslint-disable */) (default: "/**\\n * This file was auto-generated by @qraft/cli.\\n * Do not make direct changes to the file.\\n */\\n\\n")
          --filter-services <glob-patterns...>                          Filter services to be generated using glob patterns. Example: "/user/**,/post/**". For more details, see the NPM \`micromatch\` package documentation.
          --operation-predefined-parameters <patterns...>               Predefined parameters for services. The specified service parameters will be optional. Example: "/**:header.x-monite-version,query.x-api-key" or "get /**:header.x-monite-entity-id"
          --operation-name-modifier <patterns...>                       Modifies operation names using a pattern. Use the \`==>\` operator to separate the regular expression (left) and the substitution string (right). For example: "post /**:[A-Za-z]+Id ==> createOne"
          --postfix-services <string>                                   Postfix to be added to the generated service name (eg: Service)
          --service-name-base <endpoint[<index>] | tags>                Use OpenAPI Operation \`endpoint[<index>]\` path part (e.g.: "/0/1/2") or \`tags\` as the base name of the service. (default: "endpoint[0]")
          --redocly [config]                                            Use the Redocly configuration to generate multiple API clients
          If the [config] parameter is not specified, the default Redocly configuration will be used: [redocly.yaml | redocly.yml | .redocly.yaml | .redocly.yml].
          For more information about this option, use the command: --redocly-help
          Examples:
          $ bin --redocly
          $ bin my-api --redocly
          $ bin my-api@v1 my-api@v2 --redocly
          $ bin --redocly ./my-redocly-config.yaml
          --openapi-types-import-path <path>                            Path to schema types file (.d.ts), e.g.: "../schema.d.ts"
          --explicit-import-extensions [extension]                      All import statements will contain an explicit file extension. Ideal for projects using ECMAScript modules. (choices: ".js", ".ts", preset: ".js")
          --export-openapi-types [bool]                                 Add an export statement of the generated OpenAPI document types from the \`./index.ts' file. Useful for sharing types within your project. Default: true when --plugin openapi-typescript is used.
          --queryable-write-operations [bool]                           Enable generation of query hooks (useQuery, useSuspenseQuery, etc.) for writable HTTP methods like POST, PUT, PATCH. By default, only mutation hooks are generated for writable operations.
          --create-api-client-fn <functionName> [options...]            Configure API client creation function. Allows specifying the function name, included services, and callbacks. Can be specified multiple times to generate several different API client functions from a single OpenAPI document. (default: null)
          --override-import-type <pathname overrides...>                Override import paths for specific types in generated files. This allows using custom type implementations instead of the default ones. Expected format: filepath originalModule:importTypeName:customImportPath
          --operation-parameters-type-wrapper <parameters wrappers...>  Configure ParametersWrapper types for specific operation patterns. Expected format: pattern type:TypeName import:ImportPath. Can be specified multiple times for different patterns.
          -h, --help                                                    display help for command"
      `);
    });

    it('should display help with openapi-typescript plugin', async () => {
      const output = await executeBin([
        'openapi',
        '--plugin',
        'openapi-typescript',
        '--help',
      ]);
      expect(output).toMatchInlineSnapshot(`
        "ℹ ✨ OpenAPI Qraft 2.15.0-beta.0

        Usage: qraft openapi --plugin openapi-typescript [input] [options]

        Generate a type-safe TanStack Query client for React from an OpenAPI Document.

        Arguments:
          input                                            Input OpenAPI Document file path, URL (json, yml) (default: null)

        Options:
          -o, --output-dir <path>                          Output directory for generated files
          -c, --clean                                      Clean output directory before generating files
          --file-header <string>                           Header to be added to the generated file (eg: /* eslint-disable */) (default: "/**\\n * This file was auto-generated by @qraft/cli.\\n * Do not make direct changes to the file.\\n */\\n\\n")
          --filter-services <glob-patterns...>             Filter services to be generated using glob patterns. Example: "/user/**,/post/**". For more details, see the NPM \`micromatch\` package documentation.
          --operation-predefined-parameters <patterns...>  Predefined parameters for services. The specified service parameters will be optional. Example: "/**:header.x-monite-version,query.x-api-key" or "get /**:header.x-monite-entity-id"
          --operation-name-modifier <patterns...>          Modifies operation names using a pattern. Use the \`==>\` operator to separate the regular expression (left) and the substitution string (right). For example: "post /**:[A-Za-z]+Id ==> createOne"
          --postfix-services <string>                      Postfix to be added to the generated service name (eg: Service)
          --service-name-base <endpoint[<index>] | tags>   Use OpenAPI Operation \`endpoint[<index>]\` path part (e.g.: "/0/1/2") or \`tags\` as the base name of the service. (default: "endpoint[0]")
          --redocly [config]                               Use the Redocly configuration to generate multiple API clients
          If the [config] parameter is not specified, the default Redocly configuration will be used: [redocly.yaml | redocly.yml | .redocly.yaml | .redocly.yml].
          For more information about this option, use the command: --redocly-help
          Examples:
          $ bin --redocly
          $ bin my-api --redocly
          $ bin my-api@v1 my-api@v2 --redocly
          $ bin --redocly ./my-redocly-config.yaml
          --openapi-types-file-name <path>                 OpenAPI Schema types file name, e.g.: "schema.d.ts" (default: "schema.ts")
          --enum                                           Export true TS enums instead of unions
          --enum-values                                    Export enum values as arrays.
          --dedupe-enums                                   Dedupe enum types when \`--enum\` is set
          -t, --export-type                                Export top-level \`type\` instead of \`interface\`
          --immutable                                      Generate readonly types
          --additional-properties                          Treat schema objects as if \`additionalProperties: true\` is set
          --empty-objects-unknown                          Generate \`unknown\` instead of \`Record<string, never>\` for empty objects
          --default-non-nullable                           Set to \`false\` to ignore default values when generating non-nullable types
          --properties-required-by-default                 Treat schema objects as if \`required\` is set to all properties by default
          --array-length                                   Generate tuples using array minItems / maxItems
          --path-params-as-types                           Convert paths to template literal types
          --alphabetize                                    Sort object keys alphabetically
          --exclude-deprecated                             Exclude deprecated types
          --no-blob-from-binary                            If this option is enabled, binary format fields will not be converted to Blob types, preserving the native representation
          --explicit-component-exports                     Enabling this option will export API components as separate type aliases, alongside \`components\` interface
          -h, --help                                       display help for command"
      `);
    });

    it('should display help with all plugins', async () => {
      const output = await executeBin([
        'openapi',
        '--plugin',
        'tanstack-query-react',
        '--plugin',
        'openapi-typescript',
        '--help',
      ]);
      expect(output).toMatchInlineSnapshot(`
        "ℹ ✨ OpenAPI Qraft 2.15.0-beta.0

        Usage: qraft openapi --plugin tanstack-query-react --plugin openapi-typescript [input] [options]

        Generate a type-safe TanStack Query client for React from an OpenAPI Document.

        Arguments:
          input                                                         Input OpenAPI Document file path, URL (json, yml) (default: null)

        Options:
          -o, --output-dir <path>                                       Output directory for generated files
          -c, --clean                                                   Clean output directory before generating files
          --file-header <string>                                        Header to be added to the generated file (eg: /* eslint-disable */) (default: "/**\\n * This file was auto-generated by @qraft/cli.\\n * Do not make direct changes to the file.\\n */\\n\\n")
          --filter-services <glob-patterns...>                          Filter services to be generated using glob patterns. Example: "/user/**,/post/**". For more details, see the NPM \`micromatch\` package documentation.
          --operation-predefined-parameters <patterns...>               Predefined parameters for services. The specified service parameters will be optional. Example: "/**:header.x-monite-version,query.x-api-key" or "get /**:header.x-monite-entity-id"
          --operation-name-modifier <patterns...>                       Modifies operation names using a pattern. Use the \`==>\` operator to separate the regular expression (left) and the substitution string (right). For example: "post /**:[A-Za-z]+Id ==> createOne"
          --postfix-services <string>                                   Postfix to be added to the generated service name (eg: Service)
          --service-name-base <endpoint[<index>] | tags>                Use OpenAPI Operation \`endpoint[<index>]\` path part (e.g.: "/0/1/2") or \`tags\` as the base name of the service. (default: "endpoint[0]")
          --redocly [config]                                            Use the Redocly configuration to generate multiple API clients
          If the [config] parameter is not specified, the default Redocly configuration will be used: [redocly.yaml | redocly.yml | .redocly.yaml | .redocly.yml].
          For more information about this option, use the command: --redocly-help
          Examples:
          $ bin --redocly
          $ bin my-api --redocly
          $ bin my-api@v1 my-api@v2 --redocly
          $ bin --redocly ./my-redocly-config.yaml
          --openapi-types-import-path <path>                            Path to schema types file (.d.ts), e.g.: "../schema.d.ts"
          --explicit-import-extensions [extension]                      All import statements will contain an explicit file extension. Ideal for projects using ECMAScript modules. (choices: ".js", ".ts", preset: ".js")
          --export-openapi-types [bool]                                 Add an export statement of the generated OpenAPI document types from the \`./index.ts' file. Useful for sharing types within your project. Default: true when --plugin openapi-typescript is used. (default: true)
          --queryable-write-operations [bool]                           Enable generation of query hooks (useQuery, useSuspenseQuery, etc.) for writable HTTP methods like POST, PUT, PATCH. By default, only mutation hooks are generated for writable operations.
          --create-api-client-fn <functionName> [options...]            Configure API client creation function. Allows specifying the function name, included services, and callbacks. Can be specified multiple times to generate several different API client functions from a single OpenAPI document. (default: null)
          --override-import-type <pathname overrides...>                Override import paths for specific types in generated files. This allows using custom type implementations instead of the default ones. Expected format: filepath originalModule:importTypeName:customImportPath
          --operation-parameters-type-wrapper <parameters wrappers...>  Configure ParametersWrapper types for specific operation patterns. Expected format: pattern type:TypeName import:ImportPath. Can be specified multiple times for different patterns.
          --openapi-types-file-name <path>                              OpenAPI Schema types file name, e.g.: "schema.d.ts" (default: "schema.ts")
          --enum                                                        Export true TS enums instead of unions
          --enum-values                                                 Export enum values as arrays.
          --dedupe-enums                                                Dedupe enum types when \`--enum\` is set
          -t, --export-type                                             Export top-level \`type\` instead of \`interface\`
          --immutable                                                   Generate readonly types
          --additional-properties                                       Treat schema objects as if \`additionalProperties: true\` is set
          --empty-objects-unknown                                       Generate \`unknown\` instead of \`Record<string, never>\` for empty objects
          --default-non-nullable                                        Set to \`false\` to ignore default values when generating non-nullable types
          --properties-required-by-default                              Treat schema objects as if \`required\` is set to all properties by default
          --array-length                                                Generate tuples using array minItems / maxItems
          --path-params-as-types                                        Convert paths to template literal types
          --alphabetize                                                 Sort object keys alphabetically
          --exclude-deprecated                                          Exclude deprecated types
          --no-blob-from-binary                                         If this option is enabled, binary format fields will not be converted to Blob types, preserving the native representation
          --explicit-component-exports                                  Enabling this option will export API components as separate type aliases, alongside \`components\` interface
          -h, --help                                                    display help for command"
      `);
    });
  });

  describe('asyncapi command', () => {
    it('should display help without plugins', async () => {
      const output = await executeBin(['asyncapi', '--help']);
      expect(output).toMatchInlineSnapshot(`
        "ℹ ✨ AsyncAPI Qraft 1.0.0

        Usage: qraft asyncapi [input] [options]

        Arguments:
          input                                Input AsyncAPI Document file path, URL
                                               (json, yml) (default: null)

        Options:
          -o, --output-dir <path>              Output directory for generated files
          -c, --clean                          Clean output directory before generating
                                               files
          --file-header <string>               Header to be added to the generated file
                                               (eg: /* eslint-disable */) (default:
                                               "/**\\n * This file was auto-generated by
                                               @qraft/cli.\\n * Do not make direct
                                               changes to the file.\\n */\\n\\n")
          --plugin <name_1> --plugin <name_2>  Specifies which generator plugins should
                                               be used for code generation (choices:
                                               "asyncapi-typescript")
          -h, --help                           display help for command"
      `);
    });

    it('should display help with asyncapi-typescript plugin', async () => {
      const output = await executeBin([
        'asyncapi',
        '--plugin',
        'asyncapi-typescript',
        '--help',
      ]);
      expect(output).toMatchInlineSnapshot(`
        "ℹ ✨ AsyncAPI Qraft 1.0.0

        Usage: qraft asyncapi --plugin asyncapi-typescript [input] [options]

        Generate TypeScript types from an AsyncAPI Document.

        Arguments:
          input                              Input AsyncAPI Document file path, URL
                                             (json, yml) (default: null)

        Options:
          -o, --output-dir <path>            Output directory for generated files
          -c, --clean                        Clean output directory before generating
                                             files
          --file-header <string>             Header to be added to the generated file
                                             (eg: /* eslint-disable */) (default: "/**\\n
                                             * This file was auto-generated by
                                             @qraft/cli.\\n * Do not make direct changes
                                             to the file.\\n */\\n\\n")
          --asyncapi-types-file-name <path>  AsyncAPI Schema types file name, e.g.:
                                             "schema.d.ts" (default: "schema.ts")
          --enum                             Export true TS enums instead of unions
          --enum-values                      Export enum values as arrays.
          --dedupe-enums                     Dedupe enum types when \`--enum\` is set
          -t, --export-type                  Export top-level \`type\` instead of
                                             \`interface\`
          --immutable                        Generate readonly types
          --additional-properties            Treat schema objects as if
                                             \`additionalProperties: true\` is set
          --empty-objects-unknown            Generate \`unknown\` instead of
                                             \`Record<string, never>\` for empty objects
          --default-non-nullable             Set to \`false\` to ignore default values
                                             when generating non-nullable types
          --properties-required-by-default   Treat schema objects as if \`required\` is
                                             set to all properties by default
          --alphabetize                      Sort object keys alphabetically
          --exclude-deprecated               Exclude deprecated fields from types
          -h, --help                         display help for command"
      `);
    });
  });
});

function stripAnsiCodes(str: string): string {
  return str.replace(
    // eslint-disable-next-line no-control-regex
    /[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,
    ''
  );
}

async function executeBin(args: string[]): Promise<string> {
  const command = `node ${binPath} ${args.join(' ')}`;
  try {
    const { stdout, stderr } = await execAsync(command, {
      cwd: packageRoot,
      encoding: 'utf-8',
    });
    const output = (stderr ? stderr + '\n' : '') + (stdout || '');
    return stripAnsiCodes(output.trimEnd());
  } catch (error: any) {
    const output =
      (error.stderr ? error.stderr + '\n' : '') +
      (error.stdout || '') +
      (error.message || '');
    return stripAnsiCodes(output.trimEnd());
  }
}
